<!DOCTYPE html>

<html lang="en">

  <head>

    <meta charset="UTF-8">
    <title>Command 8 Tests</title>

    <script src="https://cdn.jsdelivr.net/npm/webmidi@next/dist/iife/webmidi.iife.js"></script>

    <script type="module">
      var test = 6;
      var c8in, c8out;
      WebMidi
        .enable({sysex: false})
        .then(onEnabled)
        .catch(err => alert(err));

      function onEnabled() {

        if (WebMidi.inputs.length < 1) {
          document.body.innerHTML+= "No input device detected.";
          return;
        }
        if (WebMidi.outputs.length < 1) {
            document.body.innerHTML+= "No output device detected.";
            return;
        }
        
        c8in = WebMidi.getInputByName('Command8 Port 1');
        if (c8in.state == 'connected') {
            document.body.innerHTML+= "Command8 Port 1 input connected.<br>";
        }
        else {
            document.body.innerHTML+= "Command8 Port 1 input not connected.";
            return;
        }
        c8out = WebMidi.getOutputByName('Command8 Port 1');
        if (c8out.state == 'connected') {
            document.body.innerHTML+= "Command8 Port 1 output connected.<br>";
        }
        else {
            document.body.innerHTML+= "Command8 Port 1 output not connected.";
            return;
        }

        const listener = WebMidi.inputs[0].addListener("midimessage", e => {
            switch (test)
            {
              case 1: displayFormat1(e.message); break;
              case 2: displayFormat2(e.message); break;
              case 3: displayFormat3(e.message); break;
              default: displayFormat3(e.message); break;
            }
            if (e.message.type == 'controlchange')
            {
              // display control change info
              e.message.data[1] += 1;
            }
            if (test < 4)  // don't reflect
              c8out.send(message.data);
            });
        if (test == 4)
            runTest4();
        if (test == 5)
            runTest5();
        if (test == 6)
            runTest6();
      }
      function runTest6()
      {
        var vectorQueue = [];
        var startNote = 65;
        var endNote = 65;
        var startSubVel = 0;
        var endSubVel = 0;
        var senderRate = 10;
        for (var note=startNote; note<=endNote; note++)
        {
          for (var i=0; i<2; i++)
          {
            for (var val=startSubVel; val<=endSubVel; val++)
            {
              var velocity = i==0?0:0x40;
              velocity |= val;
              vectorQueue.push([note, velocity]);
            }
          }
        }
        var timer = setInterval(test6Sender, senderRate);
        function test6Sender() {
          if (vectorQueue.length > 0)
          {
            var vector = vectorQueue.shift();
            c8out.playNote(vector[0], {channels:1, rawAttack:vector[1]});
          }
          else
          {
            clearInterval(timer);
          }
        }
      }
      function runTest5()
      {
        var vectorQueue = [];
        var startNote = 0;
        var endNote = 0;
        var startVelocity = 0;
        var endVelocity = 127;
        var senderRate = 10;
        for (var note=startNote; note<=endNote; note++)
        {
          for (var vel=startVelocity; vel<=endVelocity; vel++)
          {
            vectorQueue.push([note, vel]);
          }
        }
        var timer = setInterval(test5Sender, senderRate);
        function test5Sender() {
          if (vectorQueue.length > 0)
          {
            var vector = vectorQueue.shift();
            c8out.playNote(vector[0], {channels:1, rawAttack:vector[1]});
          }
          else
          {
            clearInterval(timer);
          }
        }
      }
      function runTest4()
      {
        var vectorQueue = [];
        for (var note=0; note<128; note++)
        {
          for (var vel=0; vel<128; vel++)
          {
            vectorQueue.push([note, vel]);
          }
        }
        var timer = setInterval(test4Sender, 10);
        function test4Sender() {
          if (vectorQueue.length > 0)
          {
            var vector = vectorQueue.shift();
            c8out.playNote(vector[0], {channels:1, rawAttack:vector[1]});
          }
          else
          {
            clearInterval(timer);
          }
        }
      }
      function displayByte(byte)
      {
        document.body.innerHTML+=byte.toString(16);
        document.body.innerHTML+=' ';
      }
      function byteString(byte, base, padlength)
      {
        if (!padlength) padlength = 7;
        var val = byte.toString(base);
        val = val.padStart(padlength, '0');
        val+=' ';
        return val;
      }
      function displayFormat1(message) {
        // display message type
        document.body.innerHTML+= `${message.type} `;
        // display message data
        document.body.innerHTML.padEnd(20,' ');
        message.data.forEach(displayByte);
        if (message.type == 'noteon')
        {
          // display note info
          document.body.innerHTML+=' note:';
          document.body.innerHTML+=byteString(message.data[1], 10);
          document.body.innerHTML+=' velocity:';
          document.body.innerHTML+=byteString(message.data[2], 10);
        }
        if (message.type == 'controlchange')
        {
          // display control change info
          document.body.innerHTML+=' controller:';
          document.body.innerHTML+=byteString(message.data[1], 10);
          document.body.innerHTML+=' value:';
          document.body.innerHTML+=byteString(message.data[2], 10);
        }
        document.body.innerHTML+='<br>';
        c8out.send(message.data);
      }
      function displayFormat2(message) {
        // display message type
        document.body.innerHTML+= `${message.type} `;
        // display message data
        message.data.forEach(displayByte);
        if (message.type == 'noteon')
        {
          // display note info
          document.body.innerHTML+=' note:';
          document.body.innerHTML+=byteString(message.data[1], 2);
          document.body.innerHTML+=' velocity:';
          document.body.innerHTML+=byteString(message.data[2], 2);
        }
        if (message.type == 'controlchange')
        {
          // display control change info
          document.body.innerHTML+=' controller:';
          document.body.innerHTML+=byteString(message.data[1], 2);
          document.body.innerHTML+=' value:';
          document.body.innerHTML+=byteString(message.data[2], 2);
        }
        document.body.innerHTML+='<br>';
        c8out.send(message.data);
      }
      function displayFormat3(message) {
        // display message type
        document.body.innerHTML+= `${message.type} `;
        // display message data
        message.data.forEach(displayByte);
        if (message.type == 'noteon')
        {
          // display note info
          document.body.innerHTML+=' note:';
          document.body.innerHTML+=byteString(message.data[1], 2);
          document.body.innerHTML+=' velocity:';
          document.body.innerHTML+=byteString(message.data[2], 2);
        }
        if (message.type == 'controlchange')
        {
          // display control change info
          document.body.innerHTML+=' controller:';
          document.body.innerHTML+=byteString(message.data[1]>>3, 2, 4);
          document.body.innerHTML+=' ';
          document.body.innerHTML+=byteString(message.data[1]&7, 2, 3);
          document.body.innerHTML+=' value:';
          document.body.innerHTML+=byteString(message.data[2], 2);
        }
        document.body.innerHTML+='<br>';
      }
    </script>

  </head>

  <body>
    <h1>Command 8 Test 6</h1>
  </body>

</html>